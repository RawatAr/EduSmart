<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
    <title>Assessment: [[${assessment.title}]] - EduSmart</title>
</head>
<body>
    <div layout:fragment="content">
        <div class="container py-4">
            <!-- Assessment Header -->
            <div class="row mb-4">
                <div class="col-12">
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="/">Home</a></li>
                            <li class="breadcrumb-item"><a href="/courses">Courses</a></li>
                            <li class="breadcrumb-item"><a href="#" th:href="@{/courses/{id}(id=${assessment.courseId})}">Course</a></li>
                            <li class="breadcrumb-item active">Assessment</li>
                        </ol>
                    </nav>

                    <div class="card bg-primary text-white">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-8">
                                    <h2 class="card-title mb-2" th:text="${assessment.title}"></h2>
                                    <p class="card-text mb-0" th:text="${assessment.description}"></p>
                                </div>
                                <div class="col-md-4 text-end">
                                    <div class="timer-display mb-2">
                                        <i class="bi bi-clock fs-4 me-2"></i>
                                        <span id="timer" class="h3 mb-0">30:00</span>
                                    </div>
                                    <small>Time Remaining</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <!-- Main Assessment Content -->
                <div class="col-lg-8">
                    <form id="assessment-form" th:action="@{/api/assessments/{id}/submit(id=${assessment.id})}" method="post">
                        <!-- Questions Container -->
                        <div id="questions-container">
                            <div th:each="question, iterStat : ${questions}" class="question-card card mb-4"
                                 th:data-question-id="${question.id}"
                                 th:classappend="${iterStat.first} ? 'active'">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">
                                        Question <span th:text="${iterStat.count}"></span> of <span th:text="${questions.size()}"></span>
                                    </h5>
                                    <span class="badge bg-primary" th:text="'Points: ' + ${question.points}"></span>
                                </div>
                                <div class="card-body">
                                    <div class="question-content mb-4">
                                        <p class="lead" th:text="${question.questionText}"></p>

                                        <!-- Multiple Choice -->
                                        <div th:if="${question.questionType.name() == 'MULTIPLE_CHOICE'}" class="options">
                                            <div th:each="option, optionIter : ${question.options}" class="form-check mb-3">
                                                <input class="form-check-input" type="radio"
                                                       th:name="'question_' + ${question.id}"
                                                       th:value="${optionIter.index}"
                                                       th:id="'option_' + ${question.id} + '_' + ${optionIter.index}">
                                                <label class="form-check-label" th:for="'option_' + ${question.id} + '_' + ${optionIter.index}"
                                                       th:text="${option}"></label>
                                            </div>
                                        </div>

                                        <!-- True/False -->
                                        <div th:if="${question.questionType.name() == 'TRUE_FALSE'}" class="options">
                                            <div class="form-check mb-3">
                                                <input class="form-check-input" type="radio"
                                                       th:name="'question_' + ${question.id}"
                                                       value="true"
                                                       th:id="'true_' + ${question.id}">
                                                <label class="form-check-label" th:for="'true_' + ${question.id}">
                                                    True
                                                </label>
                                            </div>
                                            <div class="form-check mb-3">
                                                <input class="form-check-input" type="radio"
                                                       th:name="'question_' + ${question.id}"
                                                       value="false"
                                                       th:id="'false_' + ${question.id}">
                                                <label class="form-check-label" th:for="'false_' + ${question.id}">
                                                    False
                                                </label>
                                            </div>
                                        </div>

                                        <!-- Short Answer -->
                                        <div th:if="${question.questionType.name() == 'SHORT_ANSWER'}" class="options">
                                            <textarea class="form-control"
                                                      th:name="'question_' + ${question.id}"
                                                      th:id="'answer_' + ${question.id}"
                                                      rows="3"
                                                      placeholder="Enter your answer here..."
                                                      maxlength="500"></textarea>
                                            <small class="text-muted">Maximum 500 characters</small>
                                        </div>

                                        <!-- Essay -->
                                        <div th:if="${question.questionType.name() == 'ESSAY'}" class="options">
                                            <textarea class="form-control"
                                                      th:name="'question_' + ${question.id}"
                                                      th:id="'essay_' + ${question.id}"
                                                      rows="6"
                                                      placeholder="Write your detailed answer here..."
                                                      maxlength="2000"></textarea>
                                            <small class="text-muted">Maximum 2000 characters</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Submit Button -->
                        <div class="text-center">
                            <button type="submit" class="btn btn-success btn-lg" id="submit-assessment">
                                <i class="bi bi-check-circle me-2"></i>Submit Assessment
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Sidebar -->
                <div class="col-lg-4">
                    <!-- Progress Overview -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="mb-0">Progress Overview</h6>
                        </div>
                        <div class="card-body">
                            <div class="progress mb-3" style="height: 10px;">
                                <div class="progress-bar bg-success" id="progress-bar" style="width: 0%"></div>
                            </div>
                            <div class="d-flex justify-content-between text-sm">
                                <span>Answered: <strong id="answered-count">0</strong></span>
                                <span>Total: <strong th:text="${questions.size()}"></strong></span>
                            </div>
                        </div>
                    </div>

                    <!-- Question Navigator -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="mb-0">Questions</h6>
                        </div>
                        <div class="card-body">
                            <div class="question-navigator d-flex flex-wrap gap-2">
                                <button th:each="question, iterStat : ${questions}"
                                        type="button"
                                        class="btn btn-outline-secondary btn-sm question-nav-btn"
                                        th:data-question="${iterStat.index}"
                                        th:text="${iterStat.count}"
                                        th:classappend="${iterStat.first} ? 'active'"></button>
                            </div>
                        </div>
                    </div>

                    <!-- Assessment Rules -->
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">Assessment Rules</h6>
                        </div>
                        <div class="card-body">
                            <ul class="list-unstyled small mb-0">
                                <li class="mb-2"><i class="bi bi-clock text-warning me-2"></i>Complete within time limit</li>
                                <li class="mb-2"><i class="bi bi-shield-check text-success me-2"></i>Auto-saved progress</li>
                                <li class="mb-2"><i class="bi bi-arrow-repeat text-info me-2"></i>One submission allowed</li>
                                <li class="mb-0"><i class="bi bi-trophy text-primary me-2"></i>Results shown immediately</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="card mt-3">
                        <div class="card-body d-grid gap-2">
                            <button class="btn btn-outline-warning btn-sm" id="flag-question">
                                <i class="bi bi-flag me-2"></i>Flag for Review
                            </button>
                            <button class="btn btn-outline-info btn-sm" id="save-progress">
                                <i class="bi bi-save me-2"></i>Save Progress
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Modal -->
        <div class="modal fade" id="resultsModal" tabindex="-1" aria-labelledby="resultsModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="resultsModalLabel">Assessment Results</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body" id="results-content">
                        <!-- Results will be loaded here -->
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" onclick="window.location.href='/courses'">
                            Back to Courses
                        </button>
                        <button type="button" class="btn btn-success" onclick="window.location.reload()">
                            Try Again
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div layout:fragment="scripts">
        <script>
            // Assessment/Quiz JavaScript
            document.addEventListener('DOMContentLoaded', function() {
                const assessmentId = '[[${assessment.id}]]';
                const totalQuestions = parseInt('[[${questions.size() ?: 0}]]');
                let currentQuestion = 0;
                let answeredQuestions = new Set();
                let timeLeft = 30 * 60; // 30 minutes in seconds
                let timerInterval;

                // Initialize assessment
                EduSmart.assessment.init(assessmentId, totalQuestions, timeLeft);

                // Start timer
                startTimer();

                // Bind navigation
                bindQuestionNavigation();

                // Bind form submission
                bindFormSubmission();

                // Bind save progress
                document.getElementById('save-progress').addEventListener('click', saveProgress);

                function startTimer() {
                    timerInterval = setInterval(() => {
                        timeLeft--;
                        updateTimerDisplay();

                        if (timeLeft <= 0) {
                            clearInterval(timerInterval);
                            autoSubmitAssessment();
                        } else if (timeLeft <= 300) { // 5 minutes warning
                            document.getElementById('timer').classList.add('text-danger');
                        }
                    }, 1000);
                }

                function updateTimerDisplay() {
                    const minutes = Math.floor(timeLeft / 60);
                    const seconds = timeLeft % 60;
                    document.getElementById('timer').textContent =
                        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }

                function bindQuestionNavigation() {
                    const navButtons = document.querySelectorAll('.question-nav-btn');
                    navButtons.forEach((button, index) => {
                        button.addEventListener('click', () => {
                            navigateToQuestion(index);
                        });
                    });

                    // Keyboard navigation
                    document.addEventListener('keydown', (e) => {
                        if (e.key === 'ArrowLeft' && currentQuestion > 0) {
                            navigateToQuestion(currentQuestion - 1);
                        } else if (e.key === 'ArrowRight' && currentQuestion < totalQuestions - 1) {
                            navigateToQuestion(currentQuestion + 1);
                        }
                    });
                }

                function navigateToQuestion(questionIndex) {
                    // Hide current question
                    document.querySelectorAll('.question-card').forEach(card => {
                        card.classList.remove('active');
                    });

                    // Show selected question
                    const questions = document.querySelectorAll('.question-card');
                    questions[questionIndex].classList.add('active');

                    // Update navigation buttons
                    document.querySelectorAll('.question-nav-btn').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    document.querySelectorAll('.question-nav-btn')[questionIndex].classList.add('active');

                    currentQuestion = questionIndex;

                    // Scroll to top of question
                    questions[questionIndex].scrollIntoView({ behavior: 'smooth' });
                }

                function bindFormSubmission() {
                    const form = document.getElementById('assessment-form');
                    form.addEventListener('submit', function(e) {
                        e.preventDefault();

                        if (confirm('Are you sure you want to submit your assessment? This action cannot be undone.')) {
                            submitAssessment();
                        }
                    });

                    // Track answered questions
                    const inputs = form.querySelectorAll('input, textarea');
                    inputs.forEach(input => {
                        input.addEventListener('change', updateProgress);
                        input.addEventListener('input', updateProgress);
                    });
                }

                function updateProgress() {
                    const questions = document.querySelectorAll('.question-card');
                    let answered = 0;

                    questions.forEach((question, index) => {
                        const inputs = question.querySelectorAll('input:checked, textarea:not(:placeholder-shown)');
                        if (inputs.length > 0) {
                            answered++;
                            answeredQuestions.add(index);
                        }
                    });

                    // Update progress bar
                    const progressPercentage = (answered / totalQuestions) * 100;
                    document.getElementById('progress-bar').style.width = progressPercentage + '%';
                    document.getElementById('answered-count').textContent = answered;

                    // Update navigation buttons
                    document.querySelectorAll('.question-nav-btn').forEach((btn, index) => {
                        if (answeredQuestions.has(index)) {
                            btn.classList.add('btn-success');
                            btn.classList.remove('btn-outline-secondary');
                        }
                    });
                }

                function saveProgress() {
                    const formData = new FormData(document.getElementById('assessment-form'));

                    fetch(`/api/assessments/${assessmentId}/save-progress`, {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        EduSmart.utils.showToast('Progress saved successfully!', 'success');
                    })
                    .catch(error => {
                        console.error('Save progress error:', error);
                        EduSmart.utils.showToast('Failed to save progress', 'error');
                    });
                }

                function submitAssessment() {
                    const submitBtn = document.getElementById('submit-assessment');
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Submitting...';

                    const formData = new FormData(document.getElementById('assessment-form'));

                    fetch(`/api/assessments/${assessmentId}/submit`, {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        clearInterval(timerInterval);
                        showResults(data);
                    })
                    .catch(error => {
                        console.error('Submission error:', error);
                        EduSmart.utils.showToast('Failed to submit assessment', 'error');
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = '<i class="bi bi-check-circle me-2"></i>Submit Assessment';
                    });
                }

                function autoSubmitAssessment() {
                    EduSmart.utils.showToast('Time is up! Auto-submitting your assessment...', 'warning');
                    submitAssessment();
                }

                function showResults(results) {
                    const modal = new bootstrap.Modal(document.getElementById('resultsModal'));
                    const content = document.getElementById('results-content');

                    content.innerHTML = `
                        <div class="text-center mb-4">
                            <div class="display-4 text-success mb-3">
                                <i class="bi bi-trophy"></i>
                            </div>
                            <h3>Assessment Completed!</h3>
                            <p class="lead">Here are your results:</p>
                        </div>

                        <div class="row text-center mb-4">
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-body">
                                        <h4 class="text-primary">${results.score}%</h4>
                                        <p class="text-muted mb-0">Your Score</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-body">
                                        <h4 class="text-success">${results.correctAnswers}/${results.totalQuestions}</h4>
                                        <p class="text-muted mb-0">Correct Answers</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-body">
                                        <h4 class="text-info">${results.timeSpent}</h4>
                                        <p class="text-muted mb-0">Time Spent</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="alert alert-info">
                            <h6>Performance Summary:</h6>
                            <p class="mb-0">${results.feedback}</p>
                        </div>

                        ${results.certificateEarned ? `
                            <div class="alert alert-success">
                                <i class="bi bi-award me-2"></i>
                                Congratulations! You've earned a certificate for this course.
                            </div>
                        ` : ''}
                    `;

                    modal.show();
                }
            });
        </script>
    </div>
</body>
</html>